---
import { Icon } from "astro-icon/components";

import { gacha_map } from "@/contents/data";
import { getEventAsset } from "~/lib/assets";
import { formatNumber } from "~/lib/math";
import { useCalendar } from "~/lib/unpoly/compiler/calendar/helper";
import { regionValue } from "~/lib/utilities";
import { calculateEvents } from "./_calculate";
import { getOptions } from "./_options";

export const partial = true;

const gacha = gacha_map.get(Astro.params.gacha_id!);
if (!gacha) {
	return new Response("Gacha not found.", { status: 404 });
}

const options = await getOptions(Astro);
const events = regionValue.unwrap(gacha.events)!;

const enEventDiff = (() => {
	const { en, jp } = events.past[0].startAt;
	return en!.diff(jp);
})();

const results = calculateEvents([...events.past, events.active], options);
---

<main class="text-center">
	<div class="my-4 inline-flex flex-wrap justify-center gap-1 font-medium">
		<div
			class:list={[
				"badge",
				options.target_point > 0 ? "badge-primary" : "badge-neutral",
			]}
		>
			Point : &ge;{formatNumber(options.target_point)}
		</div>
		<div
			class:list={[
				"badge",
				options.target_rank > 0 ? "badge-primary" : "badge-neutral",
			]}
		>
			Rank : &le;T{options.target_rank}
		</div>
		<div
			class:list={[
				"badge",
				options.read_event_story ? "badge-primary" : "badge-neutral",
			]}
		>
			<Icon
				name={options.read_event_story ? "lucide:check" : "lucide:x"}
				class="size-4.5"
			/>
			Story
		</div>
	</div>

	<div
		{...useCalendar({
			options,
			events: await Promise.all(
				results.map(async ({ data: event, ...stars }) => ({
					banner: await getEventAsset(Astro, { event, kind: "banner" }),
					stars,
					id: event.id,
					title: `${event.name}`,
					start: Temporal.PlainDate.from(
						event.startAt.jp.add(enEventDiff).format(),
					),
					end: Temporal.PlainDate.from(
						event.endAt.jp.add(enEventDiff).format(),
					),
				})),
			),
		})}
	>
	</div>
</main>
