---
import { gacha_map } from "@/contents/data";
import { getSongAlbumCover } from "~/lib/assets";
import { sum } from "~/lib/math";
import { calculateSongs } from "../_calculate";
import OptionsBadge from "../_components/options-badge.astro";
import { getOptions } from "../_options";

export const partial = true;

const gacha = gacha_map.get(Astro.params.gacha_id!);
if (!gacha) {
	return new Response("Gacha not found.", { status: 404 });
}

const options = await getOptions(Astro);
const results = calculateSongs(gacha.endAt.jp, options).map((it) => ({
	...it,
	total: sum([
		...Object.values(it.fullCombo).map(({ stars }) => stars),
		it.score,
	]),
}));
---

<main>
	<div
		class="my-4 inline-flex w-full flex-wrap justify-center gap-1 text-center font-medium"
	>
		<OptionsBadge name="S & SS Score" value={options.song_get_ss_score} />
		<OptionsBadge
			name="Full Combo"
			value={options.song_full_combo_level}
			formattedValue={`Level â‰¤${options.song_full_combo_level}`}
		/>
	</div>

	<ul class="list w-full">
		{
			results.map(async ({ data, fullCombo, score, total }) => (
				<li class="group list-row select-none">
					<div>
						<img
							{...await getSongAlbumCover(Astro, { song: data })}
							class="rounded-box size-16"
						/>
					</div>

					<div class="flex flex-col items-start gap-1">
						<span class="text-start text-sm font-semibold">{data.title}</span>

						<div class="inline-flex flex-wrap gap-1">
							{score > 0 && (
								<span class="badge badge-sm badge-accent">
									S &amp; SS &bullet; {score}&starf;
								</span>
							)}

							{Object.entries(fullCombo).map(
								([difficulty, { level, stars }]) => (
									<span
										data-difficulty={difficulty}
										class="badge badge-sm badge-primary bg-bandori-difficulty text-bandori-difficulty-content group-hover:bg-bandori-difficulty-alt border-bandori-difficulty"
									>
										{difficulty.toUpperCase()}
										{level} &bullet; {stars}&starf;
									</span>
								),
							)}

							<span class="badge badge-sm badge-info">
								Total : {total}&starf;
							</span>
						</div>
					</div>
				</li>
			))
		}
	</ul>
</main>
